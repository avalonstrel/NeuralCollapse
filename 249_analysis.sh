
expr_prefix="measure_test"
# config_names=cifar10_32_100_hybrid_conv_256s16k3l12
# config_names="cifar10_32_100_hybrid_conv_128down2k3l12 cifar10_32_100_hybrid_conv_128down4k3l9 cifar10_32_100_hybrid_conv_128s16k3l12 cifar10_32_100_hybrid_conv_128s16k7l12 cifar10_32_100_hybrid_conv_512down2k3l12"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_512down4k3l9 cifar10_32_100_hybrid_conv_512s4k1l12 cifar10_32_100_hybrid_conv_512s4k3l12"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_up256down2k3l12 cifar10_32_100_hybrid_conv_up256down4k3l9 cifar10_32_100_hybrid_conv_up512down2k3l12"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_up512down2k3l15_m256 cifar10_32_100_hybrid_conv_up512down2k3l15_m512 cifar10_32_100_hybrid_conv_up512down2k3l18_m256_m512 cifar10_32_100_hybrid_conv_up512down4k3l9"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_256s16k3l12 cifar10_32_100_hybrid_conv_256s16k7l12 cifar10_32_100_hybrid_conv_512s4k1l9 cifar10_32_100_hybrid_conv_512s4k1l15"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_512s4k3l9 cifar10_32_100_hybrid_conv_512s4k3l15 cifar10_32_100_hybrid_conv_512s8k3l12 cifar10_32_100_hybrid_conv_512s16k3l12 cifar10_32_100_hybrid_conv_512s16k7l12"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_512s16k7l12 cifar10_32_100_hybrid_conv_up1024down2k3l12 cifar10_32_100_hybrid_conv_up1024down4k3l9 cifar10_32_100_hybrid_conv_512down2k3l24 cifar10_32_100_hybrid_conv_512down4k3l18 cifar10_32_100_hybrid_conv_512down8k3l6 cifar10_32_100_hybrid_conv_512down8k3l12"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_128down2k3l24 cifar10_32_100_hybrid_conv_128down4k3l18 cifar10_32_100_hybrid_conv_128down8k3l6 cifar10_32_100_hybrid_conv_128down8k3l12"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_512down2k3l18_3663 cifar10_32_100_hybrid_conv_512down2k3l18_6336 cifar10_32_100_hybrid_conv_512down2k3l18_6363 cifar10_32_100_hybrid_conv_512down2k3l18_6633"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_fc_up128down4k3l9lf6_fc2048 cifar10_32_100_hybrid_conv_fc_up512down4k3l9lf3_fc2048 cifar10_32_100_hybrid_conv_fc_up512down4k3l9lf6_fc2048 cifar10_32_100_hybrid_conv_fc_up512down4k3l9lf9_fc2048 cifar10_32_100_hybrid_conv_fc_up2048down4k3l9lf6_fc2048"

# config_names="cifar10_32_100_hybrid_fc_l6_fc2048 cifar10_32_100_hybrid_fc_l9_fc2048 cifar10_32_100_hybrid_fc_l12_fc2048 cifar10_32_100_hybrid_fc_l15_fc2048"
# config_names=${config_names}" cifar10_32_100_hybrid_fc_l6_fc2048_bn cifar10_32_100_hybrid_fc_l9_fc2048_bn cifar10_32_100_hybrid_fc_l12_fc2048_bn"

# config_names="cifar10_32_100_hybrid_conv_fc_up128down4k3l9lf3_fc2048 cifar10_32_100_hybrid_conv_fc_up128down4k3l9lf3_fc2048_bn cifar10_32_100_hybrid_conv_fc_up128down4k3l9lf6_fc2048 cifar10_32_100_hybrid_conv_fc_up128down4k3l9lf6_fc2048_bn"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_fc_up128down4k3l9lf9_fc2048 cifar10_32_100_hybrid_conv_fc_up128down4k3l9lf9_fc2048_bn cifar10_32_100_hybrid_conv_fc_up256down4k3l9lf6_fc1024 cifar10_32_100_hybrid_conv_fc_up256down4k3l9lf6_fc1024_bn"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_fc_up512down4k3l9lf3_fc2048 cifar10_32_100_hybrid_conv_fc_up512down4k3l9lf3_fc2048_bn cifar10_32_100_hybrid_conv_fc_up512down4k3l9lf6_fc2048 cifar10_32_100_hybrid_conv_fc_up512down4k3l9lf6_fc2048_bn"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_fc_up512down4k3l9lf9_fc2048 cifar10_32_100_hybrid_conv_fc_up512down4k3l9lf9_fc2048_bn cifar10_32_100_hybrid_conv_fc_up2048down4k3l9lf6_fc2048 cifar10_32_100_hybrid_conv_fc_up2048down4k3l9lf6_fc2048_bn"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_512down2k3l18_6CC6 cifar10_32_100_hybrid_conv_512down2k3l18_C6C6 cifar10_32_100_hybrid_conv_512down2k3l18_C66C cifar10_32_100_hybrid_conv_512down2k3l18_CC66"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_128s8k1l12 cifar10_32_100_hybrid_conv_128s8k3l12 cifar10_32_100_hybrid_conv_128s8k5l12 cifar10_32_100_hybrid_conv_128s8k7l12"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_128s16k1l12 cifar10_32_100_hybrid_conv_128s16k3l12 cifar10_32_100_hybrid_conv_128s16k5l12 cifar10_32_100_hybrid_conv_128s16k7l12"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_1024s16k3l12"
# config_names="cifar10_32_100_hybrid_conv_128s4k1l12_norelu cifar10_32_100_hybrid_conv_128s4k3l12_norelu cifar10_32_100_hybrid_conv_128s4k7l12_norelu"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_128s16k1l12_norelu cifar10_32_100_hybrid_conv_128s16k3l12_norelu cifar10_32_100_hybrid_conv_128s16k7l12_norelu"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_512down2k3l18_6CC6 cifar10_32_100_hybrid_conv_512down2k3l18_C6C6 cifar10_32_100_hybrid_conv_512down2k3l18_C66C cifar10_32_100_hybrid_conv_512down2k3l18_CC66"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_128s4k1l12 cifar10_32_100_hybrid_conv_128s4k3l12 cifar10_32_100_hybrid_conv_128s4k5l12 cifar10_32_100_hybrid_conv_128s4k7l12"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_up128s4Ak3l12 cifar10_32_100_hybrid_conv_up128s8Ak3l12 cifar10_32_100_hybrid_conv_up128s16Ak3l12"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_up512s4Ak3l12 cifar10_32_100_hybrid_conv_up512s8Ak3l12 cifar10_32_100_hybrid_conv_up512s16Ak3l12"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_128down2Ash248k3l12 cifar10_32_100_hybrid_conv_128down2Ash284k3l12 cifar10_32_100_hybrid_conv_128down2Ash428k3l12 cifar10_32_100_hybrid_conv_128down2Ash482k3l12 cifar10_32_100_hybrid_conv_128down2Ash824k3l12"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_up128sh136s4Ak3l12 cifar10_32_100_hybrid_conv_up128sh136s16Ak3l12 cifar10_32_100_hybrid_conv_up128sh163s4Ak3l12 cifar10_32_100_hybrid_conv_up128sh163s16Ak3l12"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_up128sh316s4Ak3l12 cifar10_32_100_hybrid_conv_up128sh316s16Ak3l12 cifar10_32_100_hybrid_conv_up128sh613s4Ak3l12 cifar10_32_100_hybrid_conv_up128sh613s16Ak3l12"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_up128sh631s4Ak3l12 cifar10_32_100_hybrid_conv_up128sh631s16Ak3l12"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_up512sh152down2Ak3l12 cifar10_32_100_hybrid_conv_up512sh215down2Ak3l12 cifar10_32_100_hybrid_conv_up512sh251down2Ak3l12 cifar10_32_100_hybrid_conv_up512sh512down2Ak3l12 cifar10_32_100_hybrid_conv_up512sh521down2Ak3l12"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_up512down2Ash248k3l12 cifar10_32_100_hybrid_conv_up512down2Ash284k3l12 cifar10_32_100_hybrid_conv_up512down2Ash428k3l12 cifar10_32_100_hybrid_conv_up512down2Ash482k3l12 cifar10_32_100_hybrid_conv_up512down2Ash824k3l12"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_512s4k1l12_norelu cifar10_32_100_hybrid_conv_512s4k3l12_norelu cifar10_32_100_hybrid_conv_512s4k7l12_norelu"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_512s16k1l12_norelu cifar10_32_100_hybrid_conv_512s16k3l12_norelu cifar10_32_100_hybrid_conv_512s16k7l12_norelu"


# config_names="cifar10_32_100_hybrid_conv_512s4k1l12_norelu cifar10_32_100_hybrid_conv_512s4k3l12_norelu cifar10_32_100_hybrid_conv_512s4k7l12_norelu cifar10_32_100_hybrid_conv_128s8k1l12_norelu cifar10_32_100_hybrid_conv_128s8k3l12_norelu cifar10_32_100_hybrid_conv_128s8k7l12_norelu"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_512s16k1l12_norelu cifar10_32_100_hybrid_conv_512s16k3l12_norelu cifar10_32_100_hybrid_conv_512s16k7l12_norelu"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_128down2k3l48 cifar10_32_100_hybrid_conv_128down4k3l36 cifar10_32_100_hybrid_conv_512down2k3l48 cifar10_32_100_hybrid_conv_512down4k3l36"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_512down2k3l48 cifar10_32_100_hybrid_conv_512down4k3l36"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_128s4k1l36 cifar10_32_100_hybrid_conv_128s4k1l36_norelu cifar10_32_100_hybrid_conv_128s4k3l36 cifar10_32_100_hybrid_conv_128s4k3l36_norelu"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_128s4k7l36 cifar10_32_100_hybrid_conv_128s4k7l36_norelu cifar10_32_100_hybrid_conv_128s16k1l36 cifar10_32_100_hybrid_conv_128s16k1l36_norelu"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_128s16k3l36 cifar10_32_100_hybrid_conv_128s16k3l36_norelu cifar10_32_100_hybrid_conv_128s16k7l36 cifar10_32_100_hybrid_conv_128s16k7l36_norelu"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_512s4k1l36 cifar10_32_100_hybrid_conv_512s4k1l36_norelu cifar10_32_100_hybrid_conv_512s4k3l36 cifar10_32_100_hybrid_conv_512s4k3l36_norelu"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_512s16k1l36 cifar10_32_100_hybrid_conv_512s16k1l36_norelu cifar10_32_100_hybrid_conv_512s16k3l36 cifar10_32_100_hybrid_conv_512s16k3l36_norelu"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_up256down2k3l36 cifar10_32_100_hybrid_conv_up256down2k3l36_norelu cifar10_32_100_hybrid_conv_up256down2k3l12_norelu"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_up512down2k3l36 cifar10_32_100_hybrid_conv_up512down2k3l36_norelu cifar10_32_100_hybrid_conv_up512down2k3l12_norelu"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_up128s4Ak3l36 cifar10_32_100_hybrid_conv_up128s16Ak3l36"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_up512s4Ak3l36 cifar10_32_100_hybrid_conv_up512s16Ak3l36"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_up128s4Ak3l12_norelu cifar10_32_100_hybrid_conv_up128s4Ak3l36_norelu cifar10_32_100_hybrid_conv_up128s16Ak3l12_norelu cifar10_32_100_hybrid_conv_up128s16Ak3l36_norelu"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_up512s4Ak3l12_norelu cifar10_32_100_hybrid_conv_up512s4Ak3l36_norelu cifar10_32_100_hybrid_conv_up512s8Ak3l12_norelu cifar10_32_100_hybrid_conv_up512s16Ak3l12_norelu cifar10_32_100_hybrid_conv_up512s16Ak3l36_norelu"
# config_names=${config_names}" cifar10_32_100_hybrid_fc_l36_fc2048_bn"

# config_names="cifar10_32_100_hybrid_conv_256s16k3l12 cifar10_32_100_hybrid_conv_128down2k3l12 cifar10_32_100_hybrid_conv_128down4k3l9 cifar10_32_100_hybrid_conv_128s16k3l12 cifar10_32_100_hybrid_conv_128s16k7l12 cifar10_32_100_hybrid_conv_fc_up512down4k3l9lf3_fc2048"
config_names="cifar10_32_100_hybrid_conv_128s4k3l12" #cifar10_32_100_hybrid_conv_128s4k3l12 cifar10_32_100_hybrid_conv_128s8k3l12 cifar10_32_100_hybrid_conv_128s16k3l12
# config_names=${config_names}" cifar10_32_100_hybrid_conv_512s4k3l12 cifar10_32_100_hybrid_conv_512s8k3l12 cifar10_32_100_hybrid_conv_512s16k3l12"
# config_names=${config_names}" cifar10_32_100_hybrid_conv_128down2k3l12 cifar10_32_100_hybrid_conv_128down4k3l18 cifar10_32_100_hybrid_conv_128down2k3l24"
# # seeds="97 177 197 223 337 463 759 777 919 7 99 103"
gpu_ids=(0 1) #(4 5 6 7)  (0 1)
seeds="97 177 197"
metric_types="proj_dist"  #margin, sep_loss, sep_stn, stn, proj_dist
gpu_num=2
max_num=12
curr_num=0
C_intermediates="1"
epoch_num=1000
optim_methods="adam"
lr=0.01
norm_type=fro
fig_names=""
datadir="/sdc1/hylin/datasets"  
# datadir="/mnt/beegfs/hlinbh/datasets"  

for seed in $seeds
do
    for C_intermediate in $C_intermediates
    do
        for optim_method in $optim_methods
        do
            for config_name in $config_names    
            do
                if [ "${metric_types}" = "sep_loss" ] | [ "${metric_types}" = "sep_stn" ]; then
                    tag="conv-"${metric_types}"-C"${C_intermediate}"-E"${epoch_num}"-"${optim_method}${lr}"-block-in-down"
                elif [ "${metric_types}" = "proj_dist" ]; then
                    tag="conv-"${metric_types}"-norm"${norm_type}"-"${optim_method}${lr}"-block-in-down"
                else
                    tag="conv-"${metric_types}"-block-in-down"
                fi
                date=$seed
                
                gpu_id=${gpu_ids[$(($curr_num % $gpu_num))]}
                FINAL_FILE=./exprs/$expr_prefix/$config_name/$seed/chckpoints/iter_3500.pth
                FIG_FILE=./figures/$expr_prefix/${config_name}/$tag/${seed}_${tag}.png
                # if [ ! -f "$FINAL_FILE" ]; then
                #     echo "Not exist "$FINAL_FILE
                # fi
                
                # if [ -f "$FIG_FILE" ]; then
                #     echo "Exist "$FIG_FILE
                # fi
                
                # echo $FIG_FILE
                
                if [ -f "$FINAL_FILE" ] && [ ! -f "$FIG_FILE" ];
                then
                    echo $seed
                    echo $config_name
                    python3 analysis.py --model_names $config_name \
                                        --gpu_id $gpu_id \
                                        --seeds $seed \
                                        --feat_types $tag \
                                        --expr_prefix $expr_prefix \
                                        --C_intermediate $C_intermediate \
                                        --epoch_num $epoch_num \
                                        --metric_types $metric_types \
                                        --optim_method $optim_method \
                                        --norm_type $norm_type \
                                        --lr $lr \
                                        --data-dir $datadir 
                
                    curr_num=$(($curr_num + 1))
                    fig_names=${fig_names}" "${config_name}/$tag/${seed}_${tag}.png
                fi
                if [[ ${curr_num} -ge ${max_num} ]]
                then
                    finished_num=0
                    while [[ ${finished_num} == 0 ]]
                    do
                        sleep 300
                        finished_num=0
                        tmp_fig_names=""
                        for fig_name in $fig_names
                        do
                            FILE=./figures/$expr_prefix/$fig_name
                            if [[ -f "$FILE" ]]
                            then
                                finished_num=$(($finished_num + 1))
                                echo "Finshed: "$FILE
                            else
                                tmp_fig_names=${tmp_fig_names}" "${fig_name}
                            fi 
                        done
                        echo "Current Number:"$curr_num" Finished Number:"$finished_num
                    done
                    fig_names=${tmp_fig_names}
                    curr_num=$(($curr_num - $finished_num))
                    echo "Current Number Update:"$curr_num
                fi
            done
        done
    done
done

finished_num=0
while [[ ${finished_num} != ${curr_num} ]]
do
    sleep 1200
    finished_num=0
    for fig_name in $fig_names
    do
        FILE=./figures/$expr_prefix/$fig_name
        if [[ -f "$FILE" ]]
        then
            finished_num=$(($finished_num + 1))
            echo "Finshed: "$FILE
        fi 
    done
done

echo "Finished."
